<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>æ–°å¤§å­¦æ³•è¯­å¤ä¹ </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- æ ¸å¿ƒæ•°æ®æ–‡ä»¶ -->
  <script src="french_data.js"></script>

  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow { text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
      .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
      .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
      @keyframes shake {
        10%, 90% { transform: translate3d(-1px, 0, 0); }
        20%, 80% { transform: translate3d(2px, 0, 0); }
        30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        40%, 60% { transform: translate3d(4px, 0, 0); }
      }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.02); }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      
      .kbd { @apply cursor-pointer px-2 sm:px-3 py-1.5 rounded-lg bg-white border border-slate-200 shadow-sm text-sm font-medium hover:border-primary hover:text-primary select-none transition-all active:scale-95 text-slate-600; }
      
      /* è¯­æ³•é˜…è¯»æ ·å¼ */
      .grammar-content h3 { @apply text-lg font-bold text-indigo-700 mt-8 mb-4 border-l-4 border-indigo-500 pl-3; }
      .grammar-content h4 { @apply text-base font-bold text-slate-700 mt-4 mb-2; }
      .grammar-content p { @apply mb-3 text-slate-600 leading-relaxed; }
      .grammar-content ul { @apply list-disc list-inside mb-4 pl-2 space-y-1 text-slate-600; }
      .grammar-content table { @apply w-full text-left border-collapse mb-6 mt-2 text-sm border border-slate-200 rounded-lg overflow-hidden; }
      .grammar-content th { @apply bg-slate-100 p-3 border-b border-slate-200 font-bold text-slate-700; }
      .grammar-content td { @apply p-3 border-b border-slate-100 text-slate-600; }

      /* è¯­æ³•ç»ƒä¹ æ ·å¼ */
      .quiz-option { @apply w-full text-left p-3 rounded-lg border border-slate-200 hover:bg-slate-50 transition-all text-sm font-medium text-slate-700 mb-2 flex items-center gap-2 disabled:cursor-not-allowed; }
      .quiz-option.correct { @apply bg-emerald-50 border-emerald-200 text-emerald-700; }
      .quiz-option.wrong { @apply bg-red-50 border-red-200 text-red-700; }
    }
    body { font-family: 'Inter', 'Noto Sans SC', system-ui, sans-serif; }
  </style>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { DEFAULT: '#4f46e5', hover: '#4338ca', light: '#e0e7ff' },
            secondary: '#db2777',
            success: '#059669',
            danger: '#dc2626',
            warning: '#d97706',
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800 antialiased selection:bg-primary-light selection:text-primary pb-10">

  <div id="data-error-banner" class="hidden fixed inset-0 z-[100] bg-white/90 backdrop-blur flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl border border-red-100 text-center max-w-md">
      <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa fa-database"></i></div>
      <h2 class="text-xl font-bold text-slate-800 mb-2">æ•°æ®æ–‡ä»¶æœªåŠ è½½</h2>
      <p class="text-slate-500 mb-6">æ— æ³•æ‰¾åˆ°æ ¸å¿ƒæ•°æ®ã€‚è¯·ç¡®ä¿ <code>french_data.js</code> æ–‡ä»¶ä¸æ­¤ HTML æ–‡ä»¶ä½äºåŒä¸€ç›®å½•ã€‚</p>
      <button onclick="location.reload()" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition-colors">åˆ·æ–°é¡µé¢</button>
    </div>
  </div>

  <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-3 max-w-sm w-full pointer-events-none"></div>

  <header class="sticky top-0 z-30 bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm transition-all">
    <div class="container mx-auto px-4 h-14 sm:h-16 flex items-center justify-between max-w-6xl">
      <div class="flex items-center gap-2 sm:gap-3">
        <div class="w-8 h-8 sm:w-9 sm:h-9 rounded-xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white shadow-glow transform hover:scale-105 transition-transform">
          <i class="fa fa-book text-base sm:text-lg"></i>
        </div>
        <span class="font-bold text-base sm:text-lg tracking-tight text-slate-800 hidden sm:inline">French<span class="text-primary">Ultimate</span></span>
      </div>
      <div id="authDisplay" class="ml-4 flex items-center gap-2 text-xs">
    <button id="btnLoginModal" class="px-3 py-1 bg-slate-800 text-white rounded hover:bg-slate-700 transition">ç™»å½•/æ³¨å†Œ</button>
</div>
      
      <nav class="flex p-1 bg-slate-100/80 rounded-xl border border-slate-200/60 overflow-x-auto no-scrollbar">
        <button data-section="verbSection" class="tab-link active-tab px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm font-bold rounded-lg transition-all duration-200 text-slate-600 hover:text-slate-900 focus:outline-none flex items-center gap-2 whitespace-nowrap bg-white text-primary shadow-sm">
          <i class="fa fa-bolt"></i> <span>åŠ¨è¯ç‰¹è®­</span>
        </button>
        <button data-section="grammarSection" class="tab-link px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm font-bold rounded-lg transition-all duration-200 text-slate-600 hover:text-slate-900 focus:outline-none flex items-center gap-2 whitespace-nowrap">
          <i class="fa fa-graduation-cap"></i> <span>å…¨æœ¬è¯­æ³•</span>
        </button>
        <button data-section="lessonTransSection" class="tab-link px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm font-bold rounded-lg transition-all duration-200 text-slate-600 hover:text-slate-900 focus:outline-none flex items-center gap-2 whitespace-nowrap">
          <i class="fa fa-language"></i> <span>è¯¾æ–‡ç¿»è¯‘</span>
        </button>
        <button data-section="homeworkTransSection" class="tab-link px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm font-bold rounded-lg transition-all duration-200 text-slate-600 hover:text-slate-900 focus:outline-none flex items-center gap-2 whitespace-nowrap">
          <i class="fa fa-pencil"></i> <span>è¯¾åä¹ é¢˜</span>
        </button>
      </nav>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 sm:py-8 max-w-6xl space-y-6">
    
    <!-- ==================== 1. åŠ¨è¯æ¿å— (å®Œæ•´ä¿ç•™) ==================== -->
    <div id="verbSection" class="main-section animate-slide-up">
      <div class="bg-white rounded-2xl p-5 sm:p-6 shadow-soft border border-slate-100 mb-6 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-1 h-full bg-primary"></div>
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
          <div>
            <h1 class="text-xl sm:text-2xl font-bold text-slate-800 flex items-center gap-2">
              åŠ¨è¯å˜ä½ç‰¹è®­ <span class="text-xs px-2 py-1 rounded bg-orange-100 text-orange-600 border border-orange-200">Pro</span>
            </h1>
            <p class="text-slate-500 text-xs sm:text-sm mt-1 max-w-2xl">æ™ºèƒ½çº é”™ / è¦†ç›–æ ¸å¿ƒæ—¶æ€</p>
          </div>
          
          <div class="flex flex-wrap items-center gap-2 sm:gap-3 bg-slate-50 p-2 rounded-xl border border-slate-100 w-full lg:w-auto">
             <div class="flex flex-col w-full sm:w-auto">
               <label class="text-[10px] text-slate-400 font-bold uppercase pl-1">æ¨¡å¼</label>
               <select id="modeSel" class="bg-white text-slate-700 text-sm font-bold py-1.5 px-2 rounded border border-slate-200 outline-none focus:border-primary cursor-pointer">
                  <option value="m1">Mode 1: å•è¯æŒ‘æˆ˜</option>
                  <option value="m2">Mode 2: å…­äººç§°å…¨è¡¨</option>
                  <option value="m3">Mode 3: å­¦ä¹ æ¨¡å¼</option>
               </select>
             </div>
             <div class="flex flex-col w-full sm:w-auto">
               <label class="text-[10px] text-slate-400 font-bold uppercase pl-1">æ—¶æ€</label>
               <select id="tenseSel" class="bg-white text-slate-700 text-sm font-bold py-1.5 px-2 rounded border border-slate-200 outline-none focus:border-primary cursor-pointer">
                  <option value="pres">ç›´é™ˆå¼ç°åœ¨æ—¶</option>
                  <option value="pc">å¤åˆè¿‡å»æ—¶ (PC)</option>
                  <option value="imp">æœªå®Œæˆè¿‡å» (Imp)</option>
                  <option value="fut">ç®€å•å°†æ¥æ—¶</option>
                  <option value="futant">å…ˆå°†æ¥æ—¶</option>
                  <option value="pqp">æ„ˆè¿‡å»æ—¶</option>
                  <option value="pp">è¿‡å»åˆ†è¯ä¸“é¡¹</option>
               </select>
             </div>
             <div class="flex flex-col justify-center gap-1 pl-2">
                <div class="flex items-center gap-2" title="åªç»ƒä¹ æ ¸å¿ƒé«˜é¢‘åŠ¨è¯">
                   <input type="checkbox" id="hfOnly" class="accent-primary w-4 h-4 cursor-pointer">
                   <label for="hfOnly" class="text-xs font-bold text-slate-600 cursor-pointer select-none">ä»…é«˜é¢‘è¯</label>
                </div>
                <div class="flex items-center gap-2" title="ä¼˜å…ˆå‡ºä¹‹å‰åšé”™çš„é¢˜">
                   <input type="checkbox" id="errFirst" class="accent-warning w-4 h-4 cursor-pointer">
                   <label for="errFirst" class="text-xs font-bold text-slate-600 cursor-pointer select-none">ä¼˜å…ˆé”™é¢˜</label>
                </div>
             </div>
             <button id="btnNewSession" class="ml-2 px-3 py-1.5 bg-slate-200 hover:bg-slate-300 text-slate-700 text-xs font-bold rounded transition-colors whitespace-nowrap"><i class="fa fa-refresh"></i> é‡ç½®</button>
          </div>
        </div>

        <div class="flex flex-wrap justify-between items-center gap-2 text-xs sm:text-sm font-mono mb-6 pb-4 border-b border-slate-100">
   <button id="btnToggleProgress" class="px-4 py-1.5 bg-indigo-50 text-primary border border-indigo-100 rounded-full font-bold hover:bg-indigo-100 transition-colors flex items-center gap-2">
      <i class="fa fa-trophy"></i> é€šå…³è¿›åº¦: <b id="progressPercent">0%</b>
   </button>
   <span class="px-3 py-1.5 bg-orange-50 text-orange-600 rounded-full border border-orange-100 cursor-pointer hover:bg-orange-100 transition-colors font-bold" id="errorCountBtn">
      <i class="fa fa-exclamation-circle"></i> é”™é¢˜æ± : <b id="errorCount">0</b>
   </span>
</div>

<div id="progressPanel" class="hidden mb-8 animate-fade-in">
    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 max-h-96 overflow-y-auto custom-scrollbar">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-slate-700">åŠ¨è¯é€šå…³è¡¨ (Mode 2 å…¨å¯¹è‡ªåŠ¨ç‚¹äº®)</h3>
            <button id="btnResetProgress" class="text-xs text-red-400 hover:text-red-600 underline">é‡ç½®è¿›åº¦</button>
        </div>
        <div id="progressGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
    </div>
</div>

        <div id="m1Panel" class="max-w-2xl mx-auto py-4 text-center">
            <div class="flex justify-center gap-4 sm:gap-8 mb-8 text-lg">
                <div class="text-left"><div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">åŠ¨è¯</div><select id="verbSel" class="bg-transparent border-b-2 border-slate-200 font-bold text-slate-700 text-lg sm:text-xl py-1 outline-none w-36 sm:w-40 cursor-pointer focus:border-primary transition-colors"></select></div>
                <div class="text-left"><div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">äººç§°</div><select id="subjSel" class="bg-transparent border-b-2 border-slate-200 font-bold text-slate-700 text-lg sm:text-xl py-1 outline-none w-28 sm:w-32 cursor-pointer focus:border-primary transition-colors"><option value="random">ğŸ² éšæœº</option><option>je</option><option>tu</option><option>il/elle/on</option><option>nous</option><option>vous</option><option>ils/elles</option></select></div>
            </div>
            <div class="mb-6 relative">
                <div class="flex justify-center items-center gap-3 text-2xl sm:text-4xl font-extrabold text-slate-800 mb-6 min-h-[40px]"><span id="qSubj" class="text-slate-400 font-light">--</span> <span id="qVerb" class="text-primary">--</span></div>
                <div class="relative max-w-md mx-auto">
                    <input id="answer" type="text" class="w-full text-center text-xl sm:text-2xl bg-slate-50 border-2 border-slate-200 rounded-xl py-3 px-4 focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition-all placeholder:text-slate-300 font-bold text-slate-700" placeholder="è¾“å…¥å˜ä½..." autocomplete="off">
                    <button id="btnReveal" tabindex="-1" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 text-slate-300 hover:text-primary transition-colors" title="å·çœ‹ç­”æ¡ˆ"><i class="fa fa-eye"></i></button>
                </div>
                <div class="mt-4 flex flex-wrap justify-center gap-1.5 sm:gap-2">
                   <span class="kbd" data-ch="Ã©">Ã©</span><span class="kbd" data-ch="Ã¨">Ã¨</span><span class="kbd" data-ch="Ãª">Ãª</span><span class="kbd" data-ch="Ã ">Ã </span><span class="kbd" data-ch="Ã¹">Ã¹</span><span class="kbd" data-ch="Ã§">Ã§</span><span class="kbd" data-ch="â€™">â€™</span><span class="kbd" data-ch="Å“">Å“</span>
                </div>
                <div class="mt-2 text-xs text-slate-400">å¿«æ·é”®: e/&rarr;Ã©, e\&rarr;Ã¨, c,&rarr;Ã§ <br> <span class="text-primary font-bold">å›è½¦é”®</span>: æäº¤æ ¸å¯¹ -> å†æŒ‰åˆ‡æ¢ä¸‹ä¸€é¢˜</div>
            </div>
            <div id="feedback" class="h-8 mb-4 text-base sm:text-lg font-bold"></div>
            <div class="flex justify-center gap-3">
                <button id="btnCheck" class="px-8 py-3 bg-primary hover:bg-primary-hover text-white font-bold rounded-xl shadow-lg shadow-primary/30 active:scale-95 transition-all">æäº¤ (Enter)</button>
                <button id="btnNew" class="px-4 py-3 bg-white border border-slate-200 text-slate-500 hover:text-primary rounded-xl transition-all"><i class="fa fa-arrow-right"></i> éšæœºå‡ºé¢˜</button>
            </div>
        </div>

        <div id="m2Panel" class="hidden max-w-4xl mx-auto py-4">
            <div class="flex justify-center items-center gap-4 mb-6">
                 <div class="text-left"><div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">å½“å‰åŠ¨è¯</div><select id="verbSel6" class="bg-transparent border-b-2 border-slate-200 font-bold text-slate-700 text-xl py-1 outline-none w-40 cursor-pointer focus:border-primary transition-colors"></select></div>
                <div class="text-3xl font-extrabold text-primary" id="qVerb6">--</div>
                <button id="btnNew6" class="ml-4 px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded text-sm font-bold"><i class="fa fa-refresh"></i> æ¢è¯</button>
            </div>
            <div id="sixRows" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mb-8"></div>
            <div class="flex justify-center gap-3 border-t border-slate-100 pt-6">
                <button id="btnCheck6" class="px-8 py-3 bg-success hover:bg-success/90 text-white font-bold rounded-xl shadow-lg shadow-success/30 active:scale-95 transition-all"><i class="fa fa-check"></i> æ ¸å¯¹å…¨éƒ¨</button>
                <button id="btnNext6" class="px-6 py-3 bg-white border border-slate-200 text-slate-600 hover:text-primary rounded-xl transition-all font-bold">ä¸‹ä¸€é¢˜ <i class="fa fa-arrow-right"></i></button>
            </div>
            <div class="text-center mt-2 text-xs text-slate-400">Enter é”®è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€ç©ºï¼Œæœ€åå¯æ ¸å¯¹</div>
        </div>

        <div id="learnSection" class="hidden max-w-4xl mx-auto py-4">
             <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-slate-50 rounded-xl border border-slate-100">
                <div class="flex items-center gap-3">
                    <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="learnModeRadio" id="learnByVerb" checked class="accent-primary"> <span class="text-sm font-bold text-slate-600">æŒ‰åŠ¨è¯</span></label>
                    <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="learnModeRadio" id="learnByTense" class="accent-primary"> <span class="text-sm font-bold text-slate-600">æŒ‰æ—¶æ€</span></label>
                </div>
                <div id="verbLearnWrapper" class="flex items-center gap-2">
                   <span class="text-xs font-bold text-slate-400">åŠ¨è¯:</span> <select id="verbLearnSel" class="bg-white border border-slate-200 rounded px-2 py-1 text-sm font-bold"></select>
                </div>
                <div id="tenseLearnWrapper" class="hidden flex items-center gap-2">
                   <span class="text-xs font-bold text-slate-400">æ—¶æ€:</span>
                   <select id="tenseLearnSel" class="bg-white border border-slate-200 rounded px-2 py-1 text-sm font-bold">
                      <option value="pres">ç›´é™ˆå¼ç°åœ¨æ—¶</option><option value="fut">ç®€å•å°†æ¥æ—¶</option><option value="pc">å¤åˆè¿‡å»æ—¶</option><option value="imp">æœªå®Œæˆè¿‡å»</option><option value="pqp">æ„ˆè¿‡å»æ—¶</option><option value="pp">è¿‡å»åˆ†è¯</option>
                   </select>
                </div>
             </div>
             <div id="learnDisplay" class="space-y-6"></div>
        </div>

        <div id="errorPanel" class="mt-8 pt-6 border-t border-slate-100 hidden">
            <div class="flex justify-between items-center mb-4">
               <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fa fa-exclamation-triangle text-warning"></i> é”™é¢˜æœ¬</h3>
               <div class="flex gap-2">
                  <button id="btnExportCSV" class="px-2 py-1 text-xs border border-slate-200 rounded hover:bg-slate-50 text-slate-600">å¯¼å‡ºCSV</button>
                  <button id="btnClearErrors" class="px-2 py-1 text-xs border border-red-200 text-red-600 rounded hover:bg-red-50">æ¸…ç©º</button>
               </div>
            </div>
            <div class="overflow-x-auto rounded-lg border border-slate-200 max-h-60 overflow-y-auto custom-scrollbar">
               <table class="w-full text-sm text-left">
                  <thead class="bg-slate-50 text-slate-500 font-medium sticky top-0"><tr><th class="p-2">åŠ¨è¯</th><th class="p-2">äººç§°</th><th class="p-2">è¯¯ç­”</th><th class="p-2">æ­£è§£</th></tr></thead>
                  <tbody id="errorTableBody" class="divide-y divide-slate-100 bg-white text-slate-600"></tbody>
               </table>
            </div>
        </div>
      </div>
    </div>
    
    <!-- ==================== 2. å…¨æœ¬è¯­æ³• (å«ç»ƒä¹ æ¨¡å¼) ==================== -->
    <div id="grammarSection" class="main-section hidden animate-slide-up">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-[calc(100vh-140px)] min-h-[600px]">
        <div class="lg:col-span-1 bg-white rounded-2xl shadow-soft border border-slate-100 flex flex-col overflow-hidden">
          <div class="p-4 border-b border-slate-100 bg-slate-50/50">
             <div class="relative">
                <i class="fa fa-search absolute left-3 top-3 text-slate-400"></i><input type="text" id="grammarSearch" placeholder="æœç´¢è¯­æ³•ç‚¹..." class="w-full pl-9 pr-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/50 outline-none">
             </div>
          </div>
          <div id="grammarNav" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1"></div>
        </div>
        <div class="lg:col-span-3 bg-white rounded-2xl shadow-soft border border-slate-100 flex flex-col overflow-hidden relative">
           <div class="p-4 border-b border-slate-100 bg-slate-50/30 flex justify-between items-center shrink-0 z-10">
              <h2 id="grammarTitle" class="text-lg sm:text-xl font-bold text-slate-800 flex items-center gap-2"><i class="fa fa-book-open text-primary"></i> <span>è¯·é€‰æ‹©ç« èŠ‚</span></h2>
              <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
              <div class="flex bg-slate-200/50 rounded-lg p-1">
                <button id="btnGrammarRead" class="px-3 py-1.5 rounded-md text-xs font-bold bg-white shadow-sm text-primary transition-all"><i class="fa fa-book"></i> é˜…è¯»</button>
                <button id="btnGrammarQuiz" class="px-3 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:bg-white/50 transition-all"><i class="fa fa-pencil"></i> ç»ƒä¹ </button>
              </div>
           </div>
           <!-- é˜…è¯»å†…å®¹åŒº -->
           <div id="grammarContent" class="grammar-content flex-1 p-8 overflow-y-auto custom-scrollbar bg-white">
              <div class="flex flex-col items-center justify-center h-full text-slate-400">
                 <i class="fa fa-hand-o-left text-4xl mb-4 animate-pulse"></i>
                 <p>è¯·ä»å·¦ä¾§ç›®å½•é€‰æ‹©è¦å¤ä¹ çš„è¯­æ³•ç« èŠ‚</p>
              </div>
           </div>
           <!-- ç»ƒä¹ å†…å®¹åŒº -->
           <div id="grammarQuizPanel" class="hidden flex-1 p-8 overflow-y-auto custom-scrollbar bg-slate-50">
               <div id="quizContainer" class="max-w-2xl mx-auto space-y-6">
                  <!-- åŠ¨æ€ç”Ÿæˆé¢˜ç›® -->
               </div>
           </div>
        </div>
      </div>
    </div>

    <!-- ==================== 3. è¯¾æ–‡ç¿»è¯‘ ==================== -->
    <div id="lessonTransSection" class="main-section hidden animate-slide-up">
       <div class="bg-white rounded-2xl shadow-soft border border-slate-100 h-[calc(100vh-140px)] flex flex-col">
          <div class="p-4 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-3 bg-slate-50/30">
             <div class="flex items-center gap-2 font-bold text-slate-800"><i class="fa fa-language text-emerald-500"></i> è¯¾æ–‡ç¿»è¯‘è®­ç»ƒ (FR -> CN)</div>
             <div class="flex gap-2">
                <select id="ltMode" class="bg-white border border-slate-200 rounded px-2 py-1 text-sm font-medium focus:border-primary outline-none"><option value="full">å…¨æ–‡æ¨¡å¼</option><option value="para">æ®µè½æ¨¡å¼</option></select>
                <select id="ltLesson" class="bg-white border border-slate-200 rounded px-2 py-1 text-sm font-medium max-w-[200px] truncate focus:border-primary outline-none"></select>
             </div>
             <div class="text-xs text-slate-400 font-mono" id="ltProgress"></div>
          </div>
          <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
             <div class="flex-1 border-b md:border-b-0 md:border-r border-slate-100 p-6 overflow-y-auto custom-scrollbar bg-slate-50">
                <div class="text-xs font-bold text-slate-400 uppercase mb-2">åŸæ–‡ (FranÃ§ais)</div>
                <div id="ltSource" class="text-slate-800 leading-relaxed whitespace-pre-line text-sm sm:text-base font-medium"></div>
             </div>
             <div class="flex-1 p-6 flex flex-col bg-white">
                <div class="text-xs font-bold text-slate-400 uppercase mb-2 flex justify-between">
                   <span>ä½ çš„è¯‘æ–‡</span>
                   <div class="flex gap-2"><button id="btnLtNext" class="text-slate-500 hover:text-primary text-xs"><i class="fa fa-arrow-right"></i> è·³è¿‡</button><button id="ltShowRef" class="text-primary hover:underline text-xs flex items-center gap-1"><i class="fa fa-eye"></i> å‚è€ƒ</button></div>
                </div>
                <textarea id="ltInput" class="flex-1 w-full resize-none outline-none text-slate-700 leading-relaxed placeholder:text-slate-300 text-sm sm:text-base border border-transparent focus:border-slate-100 p-2 rounded transition-colors" placeholder="åœ¨æ­¤å°è¯•ç¿»è¯‘... (æŒ‰ Enter æŸ¥çœ‹ç­”æ¡ˆï¼Œå†æŒ‰ Enter ä¸‹ä¸€é¢˜)"></textarea>
                <div id="ltRefWrap" class="hidden mt-4 p-4 bg-emerald-50 rounded-lg border border-emerald-100 h-1/3 overflow-y-auto transition-all">
                   <div class="text-xs font-bold text-emerald-600 mb-1">å‚è€ƒè¯‘æ–‡ (Chinois):</div><div id="ltRef" class="text-emerald-800 text-sm whitespace-pre-line"></div>
                </div>
             </div>
          </div>
       </div>
    </div>

    <!-- ==================== 4. è¯¾åä¹ é¢˜ ==================== -->
    <div id="homeworkTransSection" class="main-section hidden animate-slide-up">
       <div class="bg-white rounded-2xl shadow-soft border border-slate-100 p-6 max-w-4xl mx-auto mt-6">
          <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
             <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fa fa-pencil text-secondary"></i> è¯¾åä¹ é¢˜ (CN -> FR)</h2>
             <select id="hwLesson" class="bg-slate-50 border border-slate-200 rounded px-3 py-1 text-sm font-medium focus:border-primary outline-none"></select>
          </div>
          <div class="space-y-6">
             <div class="bg-slate-50 p-5 rounded-xl border border-slate-100">
                <div class="flex justify-between mb-2"><div class="text-xs font-bold text-slate-400 uppercase">ä¸­æ–‡é¢˜ç›®</div><div class="text-xs font-mono text-slate-400" id="hwProgress">1/5</div></div>
                <div id="hwSource" class="text-lg text-slate-800 font-medium">--</div>
             </div>
             <div>
                <textarea id="hwInput" class="w-full bg-white border-2 border-slate-200 rounded-xl p-4 text-base focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition-all" rows="3" placeholder="è¯·è¾“å…¥æ³•è¯­ç¿»è¯‘..."></textarea>
                <div class="flex justify-between mt-2">
                   <div class="text-xs text-slate-400">æ”¯æŒæ™ºèƒ½å­—ç¬¦æ›¿æ¢ (e/ -> Ã©)</div>
                   <div class="flex gap-2"><button id="btnHwShowRef" class="px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg hover:border-primary hover:text-primary text-sm font-bold transition-all">æŸ¥çœ‹ç­”æ¡ˆ (Enter)</button><button id="btnHwNext" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover text-sm font-bold shadow-md transition-all">ä¸‹ä¸€é¢˜ <i class="fa fa-arrow-right"></i></button></div>
                </div>
             </div>
             <div id="hwRefWrap" class="hidden p-4 bg-indigo-50 border border-indigo-100 rounded-xl text-indigo-900 animate-fade-in">
                <div class="text-xs font-bold text-indigo-400 mb-1 uppercase">å‚è€ƒç­”æ¡ˆ (FranÃ§ais)</div><div id="hwRef" class="text-lg font-medium"></div>
             </div>
          </div>
       </div>
    </div>
  </main>
<div id="authModal" class="hidden fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
        <div class="p-6 space-y-4">
            <h3 class="text-xl font-bold text-slate-800">è´¦å·åŒæ­¥</h3>
            <input type="email" id="authEmail" class="w-full border p-2 rounded" placeholder="é‚®ç®±">
            <input type="password" id="authPwd" class="w-full border p-2 rounded" placeholder="å¯†ç  (è‡³å°‘6ä½)">
            <div id="authMsg" class="text-xs text-red-500 h-4"></div>
            <div class="flex gap-3">
                <button id="btnDoLogin" class="flex-1 py-2 bg-primary text-white rounded font-bold">ç™»å½•</button>
                <button id="btnDoSignUp" class="flex-1 py-2 border rounded font-bold">æ³¨å†Œ</button>
            </div>
            <button onclick="document.getElementById('authModal').classList.add('hidden')" class="w-full text-xs text-slate-400 mt-2">å…³é—­</button>
        </div>
    </div>
</div>
  <script>
    // åŸºç¡€å‡½æ•°
    function norm(str) { return (str || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim().toLowerCase().replace(/â€™/g, "'").replace(/\s+/g, ' '); }
    function showToast(msg, type='info') {
       const c = document.getElementById('toast-container');
       const d = document.createElement('div');
       const colors = type==='success' ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : (type==='error' ? 'bg-red-50 text-red-600 border-red-200' : 'bg-white text-slate-700 border-slate-200');
       d.className = `p-3 rounded-lg shadow-lg border text-sm font-bold flex items-center gap-2 animate-fade-in ${colors}`;
       d.innerHTML = `<i class="fa fa-${type==='success'?'check-circle':(type==='error'?'times-circle':'info-circle')}"></i> ${msg}`;
       c.appendChild(d);
       setTimeout(() => d.remove(), 3000);
    }
    function smartInputHandler(e) {
       const map = {'e/':'Ã©', 'e\\':'Ã¨', 'e^':'Ãª', 'a\\':'Ã ', 'u\\':'Ã¹', 'c,':'Ã§', 'i^':'Ã®', 'o^':'Ã´'};
       const el = e.target; let val = el.value; let changed = false;
       for(let k in map){ if(val.includes(k)){ val = val.replace(k, map[k]); changed = true; } }
       if(changed) el.value = val;
    }

    // æ•°æ®å±‚
    const Data = {
      get verbs() { return window.VERB_LIST || []; },
      get hfVerbs() { return window.HF_VERB_LIST || window.VERB_LIST || []; },
      get present() { return window.PRESENT || {}; },
      get pp() { return window.PP || {}; },
      get aux() { return window.AUX || {}; },
      get futurStem() { return window.FUTUR_STEM || {}; },
      get futurEnd() { return window.FUTUR_END || {}; },
      get impEnd() { return window.IMP_END || {}; },
      get etreVerbs() { return window.ETRE_VERBS || new Set(); },
      get lessonsRaw() { return window.LESSONS_RAW || []; },
      get homeworkRaw() { return window.HOMEWORK_RAW || []; },
      get grammarBook() { return window.GRAMMAR_BOOK || []; },
      isReflexive(v) { return v.includes("asseoir") || v.startsWith("se ") || v.startsWith("s'"); },
      getSubjects(v) { if(v.startsWith("falloir")||v.startsWith("pleuvoir")) return ["il/elle/on"]; return ["je","tu","il/elle/on","nous","vous","ils/elles"]; },
      buildReflexiveMainChunk(subj, v){
        const beginsWithVowel = (s) => /^[aeiouhÃ¢Ã Ã©Ã¨ÃªÃ®Ã¯Ã´Ã»Ã¹]/i.test(s||'');
        if(subj==="je") return beginsWithVowel(v) ? "m'"+v : "me "+v;
        if(subj==="tu") return beginsWithVowel(v) ? "t'"+v : "te "+v;
        if(subj==="il/elle/on") return beginsWithVowel(v) ? "s'"+v : "se "+v;
        if(subj==="nous") return "nous "+v;
        if(subj==="vous") return "vous "+v;
        return beginsWithVowel(v) ? "s'"+v : "se "+v;
      },
      expectedAnswers(verb, subj, tense) {
         // (æ­¤å¤„çœç•¥å…·ä½“å˜ä½é€»è¾‘ï¼Œä¸å‰ç‰ˆä¸€è‡´ï¼Œè°ƒç”¨ window æ•°æ®)
         if(tense==="pres") return (this.present[verb] && this.present[verb][subj]) ? this.present[verb][subj] : [""];
         if(tense==="pp") {
             const p = this.pp[verb] || verb; const v=[p];
             if(this.isReflexive(verb) || (this.etreVerbs.has && this.etreVerbs.has(verb))) ["e","s","es"].forEach(s=>v.push(p+s));
             return v;
         }
         if(tense==="fut") {
             if(verb.startsWith("pleuvoir")) return ["pleuvra"];
             if(verb.startsWith("falloir")) return ["faudra"];
             let stem = this.futurStem[verb]; if(!stem){ stem = verb.endsWith("re")?verb.slice(0,-1):verb; }
             const form = stem + (this.futurEnd[subj]||"");
             return this.isReflexive(verb) ? [this.buildReflexiveMainChunk(subj, form)] : [form];
         }
         if(tense==="imp") {
             if(verb.startsWith("pleuvoir")) return ["pleuvait"];
             if(verb.startsWith("falloir")) return ["fallait"];
             if(this.isReflexive(verb)){
                const end = this.impEnd[subj]||"";
                return [this.buildReflexiveMainChunk(subj,"assey"+end), this.buildReflexiveMainChunk(subj,"assoy"+end)];
             }
             if(verb==="Ãªtre") return ["Ã©t"+(this.impEnd[subj]||"")];
             const nousForm = (this.present[verb]&&this.present[verb]["nous"]) ? this.present[verb]["nous"][0] : null;
             if(!nousForm) return [(verb.endsWith("re")||verb.endsWith("ir") ? verb.slice(0,-2) : verb)+(this.impEnd[subj]||"")];
             return [nousForm.replace(/e?ons$/,"")+(this.impEnd[subj]||"")];
         }
         if(tense==="pc" || tense==="pqp" || tense==="futant") {
             if(verb.startsWith("pleuvoir")) return [ (this.aux["avoir"][tense==="pc"?"pres":(tense==="pqp"?"imp":"fut")]["il/elle/on"]||"") + " " + (this.pp[verb]||"") ];
             const base = this.isReflexive(verb) ? "Ãªtre" : ((this.etreVerbs.has && this.etreVerbs.has(verb)) ? "Ãªtre" : "avoir");
             const tCode = tense==="pc"?"pres":(tense==="pqp"?"imp":"fut");
             const auxForm = this.aux[base]?.[tCode]?.[subj] || "";
             const pp = this.pp[verb] || verb;
             if(this.isReflexive(verb) || base==="Ãªtre") {
                const chunk = this.isReflexive(verb) ? this.buildReflexiveMainChunk(subj, auxForm) : auxForm;
                return [chunk + " " + pp, chunk + " " + pp + "e", chunk + " " + pp + "s", chunk + " " + pp + "es"]; 
             }
             return [auxForm + " " + pp];
         }
         return ["?"];
      }
    };

   // ============================================================
    // VerbManager (æ–°ç‰ˆ - å«è¿›åº¦è¿½è¸ª)
    // ============================================================
    class VerbManager {
       constructor() {
          // åªä¿ç•™é”™é¢˜æœ¬é€»è¾‘ï¼Œç§»é™¤ tries/ok/bad
          this.session = { errors: [] };
          this.progress = {}; // æ ¼å¼: { "aimer_pres": true, "aller_fut": true }
          this.m2Checked = false; 
          this.m1Awaiting = false;
          this.verbs = [];
          
          // åŠ è½½é”™é¢˜
          try { const savedErr = localStorage.getItem('fr_errors'); if(savedErr) this.session.errors = JSON.parse(savedErr); } catch(e){}
          // åŠ è½½è¿›åº¦
          try { const savedProg = localStorage.getItem('fr_progress'); if(savedProg) this.progress = JSON.parse(savedProg); } catch(e){}

          this.el = {
             mode: document.getElementById('modeSel'), tense: document.getElementById('tenseSel'), 
             hf: document.getElementById('hfOnly'), errFirst: document.getElementById('errFirst'),
             m1: document.getElementById('m1Panel'), m2: document.getElementById('m2Panel'), learn: document.getElementById('learnSection'),
             verbSel: document.getElementById('verbSel'), subjSel: document.getElementById('subjSel'), ans: document.getElementById('answer'),
             fb: document.getElementById('feedback'), verbSel6: document.getElementById('verbSel6'), sixRows: document.getElementById('sixRows'),
             errPanel: document.getElementById('errorPanel'), errBody: document.getElementById('errorTableBody'),
             // æ–°å¢ UI å…ƒç´ 
             progressBtn: document.getElementById('btnToggleProgress'),
             progressPanel: document.getElementById('progressPanel'),
             progressGrid: document.getElementById('progressGrid'),
             progressPercent: document.getElementById('progressPercent'),
             resetProgBtn: document.getElementById('btnResetProgress')
          };
          this.init();
       }

       init() { 
          this.updateVerbList(); 
          this.bindEvents(); 
          this.initLearn(); 
          this.newSession(); 
          this.renderErrors(); 
          this.updateProgressUI(); // åˆå§‹åŒ–æ˜¾ç¤ºè¿›åº¦
          this.auth = new AuthManager(this);
       }

       saveErrors() { 
          localStorage.setItem('fr_errors', JSON.stringify(this.session.errors)); 
          this.renderErrors(); 
          document.getElementById('errorCount').textContent = this.session.errors.length; 
          if(this.auth) this.auth.saveData('errors', this.session.errors);
       }
       
       // æ–°å¢ï¼šä¿å­˜è¿›åº¦
       markProgress(verb, tense) {
          const key = `${verb}_${tense}`;
          if (!this.progress[key]) {
             this.progress[key] = true;
             localStorage.setItem('fr_progress', JSON.stringify(this.progress));
             this.updateProgressUI();
             showToast(`è§£é”æˆå°±ï¼š${verb} (${tense})`, 'success');
             if(this.auth) this.auth.saveData('progress', this.progress);
          }
       }

       removeError(verb, subj) { 
          this.session.errors = this.session.errors.filter(e => !(e.v === verb && e.s === subj)); 
          this.saveErrors(); 
       }

       updateVerbList() {
          this.verbs = (this.el.hf && this.el.hf.checked) ? Data.hfVerbs : Data.verbs;
          const fill = (s) => { 
             const val = s.value; 
             s.innerHTML = '<option value="random">ğŸ² éšæœº</option>' + this.verbs.map(v => `<option>${v}</option>`).join(''); 
             if (this.verbs.includes(val)) s.value = val; 
          };
          fill(this.el.verbSel); fill(this.el.verbSel6);
          const learnSel = document.getElementById('verbLearnSel');
          if(learnSel) { learnSel.innerHTML = ''; this.verbs.forEach(v => learnSel.innerHTML += `<option>${v}</option>`); }
          
          this.updateProgressUI(); // åˆ—è¡¨æ›´æ–°æ—¶åˆ·æ–°è¿›åº¦è§†å›¾
       }

       bindEvents() {
          this.el.mode.addEventListener('change', () => this.switchMode());
          this.el.tense.addEventListener('change', () => this.refreshQ());
          this.el.hf.addEventListener('change', () => { this.updateVerbList(); this.refreshQ(); if(this.el.mode.value==='m3') this.renderLearn(); });
          
          this.el.verbSel.addEventListener('change', () => this.newM1(true));
          this.el.subjSel.addEventListener('change', () => this.newM1(true));
          
          document.getElementById('btnNew').addEventListener('click', () => this.newM1());
          document.getElementById('btnCheck').addEventListener('click', () => this.checkM1());
          document.getElementById('btnReveal').addEventListener('click', () => { 
             if(this.curr) this.el.ans.value = Data.expectedAnswers(this.curr.v, this.curr.s, this.el.tense.value)[0]; 
             this.el.ans.focus(); 
          });
          
          this.el.ans.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); this.checkM1(); } });
          this.el.ans.addEventListener('input', smartInputHandler);
          
          document.querySelectorAll('.kbd').forEach(k => k.addEventListener('click', () => { 
             const v = this.el.ans.value; const p = this.el.ans.selectionStart; 
             this.el.ans.value = v.slice(0,p) + k.dataset.ch + v.slice(p); 
             this.el.ans.focus(); this.el.ans.setSelectionRange(p+1, p+1); 
          }));
          
          document.getElementById('btnNew6').addEventListener('click', () => this.newM2());
          document.getElementById('btnNext6').addEventListener('click', () => this.newM2());
          document.getElementById('btnCheck6').addEventListener('click', () => this.checkM2());
          
          document.getElementById('sixRows').addEventListener('keydown', (e) => { 
             if(e.key === 'Enter' && e.target.tagName === 'INPUT') { 
                e.preventDefault(); 
                const inputs = Array.from(this.el.sixRows.querySelectorAll('input')); 
                const idx = inputs.indexOf(e.target); 
                if (idx < inputs.length - 1) { inputs[idx + 1].focus(); } 
                else { if (this.m2Checked) this.newM2(); else this.checkM2(); } 
             } 
          });
          
          document.getElementById('errorCountBtn').addEventListener('click', () => { this.el.errPanel.classList.toggle('hidden'); });
          document.getElementById('btnClearErrors').addEventListener('click', () => { if(confirm('æ°¸ä¹…æ¸…ç©ºé”™é¢˜æœ¬?')){ this.session.errors=[]; this.saveErrors(); } });
          document.getElementById('btnExportCSV').addEventListener('click', () => this.exportCSV());
          
          // åŸé‡ç½®æŒ‰é’®é€»è¾‘ä¿®æ”¹ï¼šåªåˆ·æ–°é¢˜ç›®ï¼Œä¸æ¶‰åŠä¸å­˜åœ¨çš„ç»Ÿè®¡
          document.getElementById('btnNewSession').addEventListener('click', () => { 
             this.refreshQ(); 
             showToast('é¢˜ç›®å·²åˆ·æ–°', 'info');
          });

          // æ–°å¢ï¼šè¿›åº¦ç›¸å…³äº‹ä»¶
          this.el.progressBtn.addEventListener('click', () => {
             this.el.progressPanel.classList.toggle('hidden');
          });
          this.el.resetProgBtn.addEventListener('click', () => {
             if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é€šå…³è®°å½•å—ï¼Ÿæ— æ³•æ¢å¤ã€‚')) {
                this.progress = {};
                localStorage.removeItem('fr_progress');
                this.updateProgressUI();
             }
          });
       }

       switchMode() {
          const m = this.el.mode.value;
          this.el.m1.classList.add('hidden'); this.el.m2.classList.add('hidden'); this.el.learn.classList.add('hidden');
          if(m==='m1') { this.el.m1.classList.remove('hidden'); this.newM1(); }
          if(m==='m2') { this.el.m2.classList.remove('hidden'); this.newM2(); }
          if(m==='m3') { this.el.learn.classList.remove('hidden'); this.renderLearn(); }
       }

       refreshQ() { 
          this.el.mode.value==='m1' ? this.newM1() : (this.el.mode.value==='m2' ? this.newM2() : this.renderLearn()); 
       }

       newSession() { 
          this.switchMode(); 
          this.renderStats(); 
       }

       newM1(preserveSelection = false) {
          this.m1Awaiting = false; let v, s;
          if (!preserveSelection && this.el.errFirst.checked && this.session.errors.length > 0) {
             const err = this.session.errors[Math.floor(Math.random()*this.session.errors.length)]; v = err.v; s = err.s;
             if(this.verbs.includes(v)) this.el.verbSel.value = v; this.el.subjSel.value = s; showToast(`å¤ä¹ é”™é¢˜ï¼š${v}`, 'info');
          } else if (preserveSelection) {
             v = this.el.verbSel.value === 'random' ? this.verbs[Math.floor(Math.random()*this.verbs.length)] : this.el.verbSel.value;
             const subs = Data.getSubjects(v);
             s = (this.el.subjSel.value === 'random' || !subs.includes(this.el.subjSel.value)) ? subs[Math.floor(Math.random()*subs.length)] : this.el.subjSel.value;
          } else {
             v = this.el.verbSel.value==='random' ? this.verbs[Math.floor(Math.random()*this.verbs.length)] : this.el.verbSel.value;
             const subs = Data.getSubjects(v);
             s = this.el.subjSel.value==='random' ? subs[Math.floor(Math.random()*subs.length)] : this.el.subjSel.value;
          }
          this.curr = { v, s }; 
          document.getElementById('qVerb').textContent = v; 
          document.getElementById('qSubj').textContent = s;
          this.el.ans.value = ''; 
          this.el.fb.textContent = ''; 
          this.el.ans.className = 'w-full text-center text-xl sm:text-2xl bg-slate-50 border-2 border-slate-200 rounded-xl py-3 px-4 focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition-all placeholder:text-slate-300 font-bold text-slate-700';
          this.el.ans.focus(); 
          document.getElementById('btnCheck').textContent = "æäº¤ (Enter)";
       }

       checkM1() {
          if (this.m1Awaiting) { this.newM1(); return; }
          const val = norm(this.el.ans.value); 
          const right = Data.expectedAnswers(this.curr.v, this.curr.s, this.el.tense.value).map(norm);
          
          if(right.includes(val)) {
             this.el.ans.classList.add('border-green-500','bg-green-50','animate-pulse'); 
             this.el.fb.innerHTML='<span class="text-emerald-600"><i class="fa fa-check"></i> æ­£ç¡®! (æŒ‰å›è½¦ç»§ç»­)</span>';
             this.removeError(this.curr.v, this.curr.s); 
             this.m1Awaiting = true; 
             document.getElementById('btnCheck').textContent = "ä¸‹ä¸€é¢˜ (Enter)";
          } else {
             this.el.ans.classList.add('border-red-500','bg-red-50','animate-shake'); 
             this.el.fb.innerHTML=`<span class="text-red-600">é”™è¯¯. å‚è€ƒ: ${Data.expectedAnswers(this.curr.v, this.curr.s, this.el.tense.value)[0]}</span>`;
             setTimeout(()=>this.el.ans.classList.remove('animate-shake'), 500);
             this.session.errors.push({v:this.curr.v, s:this.curr.s, u:this.el.ans.value, r:Data.expectedAnswers(this.curr.v, this.curr.s, this.el.tense.value)[0]});
             this.saveErrors(); 
             this.m1Awaiting = true; 
             document.getElementById('btnCheck').textContent = "ä¸‹ä¸€é¢˜ (Enter)";
          }
       }

       newM2() {
          this.m2Checked = false; 
          const v = this.el.verbSel6 && this.el.verbSel6.value !== 'random' ? this.el.verbSel6.value : this.verbs[Math.floor(Math.random()*this.verbs.length)];
          document.getElementById('qVerb6').textContent = v; 
          this.el.sixRows.innerHTML = '';
          Data.getSubjects(v).forEach(s => {
             this.el.sixRows.innerHTML += `<div class="flex items-center gap-2 mb-2" data-s="${s}"><span class="w-16 text-right font-bold text-slate-500 text-xs uppercase">${s}</span><input class="m2-in flex-1 bg-white border border-slate-200 rounded px-2 py-2 outline-none focus:border-primary" placeholder="?"><span class="w-6 fb-icon"></span></div>`;
          });
          this.curr6 = v; 
          document.getElementById('btnCheck6').innerHTML = '<i class="fa fa-check"></i> æ ¸å¯¹å…¨éƒ¨'; 
          const first = this.el.sixRows.querySelector('input'); if(first) first.focus();
       }

       checkM2() {
          this.m2Checked = true; 
          let allOk = true;
          const currentTense = this.el.tense.value;

          this.el.sixRows.querySelectorAll('div[data-s]').forEach(row => {
             const s = row.dataset.s; 
             const inp = row.querySelector('.m2-in'); 
             const icon = row.querySelector('.fb-icon');
             const val = norm(inp.value); 
             const right = Data.expectedAnswers(this.curr6, s, currentTense).map(norm);
             
             if(right.includes(val)) {
                inp.classList.add('border-green-500','bg-green-50'); 
                icon.innerHTML='<i class="fa fa-check text-green-500"></i>'; 
                this.removeError(this.curr6, s);
             } else {
                allOk = false; 
                inp.classList.add('border-red-500','bg-red-50'); 
                icon.innerHTML='<i class="fa fa-times text-red-500"></i>';
                this.session.errors.push({v:this.curr6, s:s, u:inp.value, r:Data.expectedAnswers(this.curr6, s, currentTense)[0]});
                inp.value += ` (${Data.expectedAnswers(this.curr6, s, currentTense)[0]})`;
             }
          });

          if(!allOk) this.saveErrors();

          if(allOk) { 
             showToast('å…¨å¯¹ï¼å®Œç¾ï¼', 'success');
             // ============ æ ¸å¿ƒä¿®æ”¹ï¼šå…¨å¯¹æ—¶è®°å½•è¿›åº¦ ============
             this.markProgress(this.curr6, currentTense);
             // ===============================================
             setTimeout(() => this.newM2(), 1200); 
          } else { 
             document.getElementById('btnCheck6').innerHTML = 'ä¸‹ä¸€é¢˜ <i class="fa fa-arrow-right"></i>'; 
             document.getElementById('btnCheck6').onclick = () => { 
                this.newM2(); 
                document.getElementById('btnCheck6').onclick = () => this.checkM2(); 
             }; 
          }
       }

       // æ–°å¢ï¼šæ¸²æŸ“è¿›åº¦ç½‘æ ¼
       updateProgressUI() {
          const tenses = [
             {k:'pres', n:'ç°'}, {k:'fut', n:'å°†'}, {k:'pc', n:'å¤'}, 
             {k:'imp', n:'æœª'}, {k:'pqp', n:'æ„ˆ'}, {k:'pp', n:'åˆ†'}
          ];
          
          let totalItems = this.verbs.length * tenses.length;
          let doneItems = 0;

          this.el.progressGrid.innerHTML = '';
          
          this.verbs.forEach(v => {
             let badges = '';
             tenses.forEach(t => {
                const isDone = this.progress[`${v}_${t.k}`];
                if(isDone) doneItems++;
                const color = isDone ? 'bg-emerald-500 text-white border-emerald-600' : 'bg-slate-100 text-slate-300 border-slate-200';
                // ç‚¹å‡»Badgeè·³è½¬åˆ°è¯¥åŠ¨è¯è¯¥æ—¶æ€è¿›è¡Œç»ƒä¹ 
                badges += `<span class="px-1.5 py-0.5 text-[10px] rounded border ${color} cursor-default" title="${t.n}">${t.n}</span>`;
             });

             const card = document.createElement('div');
             card.className = "bg-white p-3 rounded-lg border border-slate-100 shadow-sm flex flex-col gap-2";
             card.innerHTML = `
                <div class="font-bold text-slate-700 text-sm flex justify-between">
                   <span>${v}</span>
                </div>
                <div class="flex gap-1 flex-wrap">${badges}</div>
             `;
             this.el.progressGrid.appendChild(card);
          });

          const pct = Math.round((doneItems / totalItems) * 100) || 0;
          this.el.progressPercent.textContent = `${pct}%`;
       }

       initLearn() {
          document.getElementById('verbLearnSel').addEventListener('change', ()=>this.renderLearn());
          document.getElementById('tenseLearnSel').addEventListener('change', ()=>this.renderLearn());
          document.getElementsByName('learnModeRadio').forEach(r => r.addEventListener('change', (e) => {
             document.getElementById('verbLearnWrapper').classList.toggle('hidden', e.target.id==='learnByTense');
             document.getElementById('tenseLearnWrapper').classList.toggle('hidden', e.target.id==='learnByVerb');
             this.renderLearn();
          }));
       }

       renderLearn() {
          const mode = document.getElementById('learnByTense').checked ? 'tense' : 'verb';
          const container = document.getElementById('learnDisplay'); container.innerHTML = '';
          const vs = document.getElementById('verbLearnSel');
          if(vs.options.length === 0) this.verbs.forEach(v => vs.innerHTML+=`<option>${v}</option>`);
          if(mode === 'verb') {
             const v = vs.value || this.verbs[0]; const tenses = ['pres','pc','imp','fut','futant','pqp','pp'];
             tenses.forEach(t => {
                let html = `<div class="mb-4 bg-white p-4 rounded border border-slate-100"><h4 class="font-bold text-slate-700 mb-2 border-b pb-1">${t.toUpperCase()}</h4><div class="grid grid-cols-2 md:grid-cols-3 gap-2">`;
                Data.getSubjects(v).forEach(s => { html += `<div><span class="text-xs text-slate-400 block">${s}</span><span class="font-mono text-primary font-medium">${Data.expectedAnswers(v,s,t)[0]}</span></div>`; });
                container.innerHTML += html + '</div></div>';
             });
          } else {
             const t = document.getElementById('tenseLearnSel').value; const list = this.verbs; 
             list.forEach(v => {
                 let html = `<div class="mb-2 pb-2 border-b border-slate-100 flex flex-wrap gap-4 items-center"><span class="font-bold w-24 text-slate-700">${v}</span>`;
                 Data.getSubjects(v).forEach(s => { html += `<span class="text-sm"><span class="text-slate-300 text-xs">${s}</span> ${Data.expectedAnswers(v,s,t)[0]}</span>`; });
                 container.innerHTML += html + '</div>';
             });
          }
       }

       renderStats() { 
          // ä»…æ›´æ–°é”™é¢˜æ•°
          document.getElementById('errorCount').textContent = this.session.errors.length; 
       }

       renderErrors() { 
          this.el.errBody.innerHTML = ''; 
          this.session.errors.slice().reverse().slice(0, 20).forEach(e => { 
             this.el.errBody.innerHTML += `<tr class="border-b"><td class="p-2">${e.v}</td><td class="p-2">${e.s}</td><td class="p-2 text-red-500">${e.u}</td><td class="p-2 text-green-600">${e.r}</td></tr>`; 
          }); 
       }

       exportCSV() { 
          const csv = "Verb,Subject,User,Correct\n" + this.session.errors.map(e => `${e.v},${e.s},"${e.u}","${e.r}"`).join("\n"); 
          const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv); a.download = 'errors.csv'; a.click(); 
       }
    }

    // ============================================================
    // GrammarManager - å‡çº§æ”¯æŒç»ƒä¹ æ¨¡å¼
    // ============================================================
    class GrammarManager {
       constructor() {
          this.data = Data.grammarBook;
          this.state = { part: 0, chapter: 0, mode: 'read' }; // read | quiz
          this.el = {
             nav: document.getElementById('grammarNav'),
             title: document.getElementById('grammarTitle'),
             content: document.getElementById('grammarContent'),
             quizPanel: document.getElementById('grammarQuizPanel'),
             quizContainer: document.getElementById('quizContainer'),
             btnRead: document.getElementById('btnGrammarRead'),
             btnQuiz: document.getElementById('btnGrammarQuiz')
          };
          this.init();
       }

       init() {
          this.renderNav();
          this.loadChapter(0, 0);

          // ç»‘å®šæ¨¡å¼åˆ‡æ¢
          this.el.btnRead.addEventListener('click', () => this.switchMode('read'));
          this.el.btnQuiz.addEventListener('click', () => this.switchMode('quiz'));
          
          // æœç´¢åŠŸèƒ½
          document.getElementById('grammarSearch').addEventListener('input', (e) => {
             const q = e.target.value.toLowerCase();
             Array.from(this.el.nav.querySelectorAll('button')).forEach(b => {
                b.style.display = b.textContent.toLowerCase().includes(q) ? 'block' : 'none';
             });
          });
       }

       renderNav() {
          if (!this.data) return;
          this.el.nav.innerHTML = '';
          this.data.forEach((part, pIdx) => {
             let html = `<div class="mb-4"><div class="text-xs font-bold text-slate-400 uppercase mb-2 px-2">${part.title}</div><div class="space-y-1">`;
             part.chapters.forEach((c, cIdx) => {
                html += `<button id="nav-${pIdx}-${cIdx}" class="w-full text-left px-3 py-2 rounded-lg text-sm text-slate-600 hover:bg-slate-50 transition-colors" onclick="gm.loadChapter(${pIdx},${cIdx})">${c.title}</button>`;
             });
             html += '</div></div>';
             this.el.nav.innerHTML += html;
          });
       }

       loadChapter(pIdx, cIdx) {
          this.state.part = pIdx;
          this.state.chapter = cIdx;
          const ch = this.data[pIdx].chapters[cIdx];
          
          // æ ‡é¢˜æ›´æ–°
          this.el.title.querySelector('span').textContent = ch.title;
          
          // å†…å®¹æ›´æ–°
          this.el.content.innerHTML = `<div class="animate-fade-in text-slate-700">${ch.content}</div>`;
          
          // ç»ƒä¹ æ›´æ–° - å³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿå°è¯•åŠ è½½ï¼Œä»¥ä¾¿æ˜¾ç¤ºâ€œæš‚æ— ç»ƒä¹ â€
          this.renderQuiz(ch.id);

          // é«˜äº®å¯¼èˆª
          this.el.nav.querySelectorAll('button').forEach(b => b.classList.remove('bg-indigo-50', 'text-primary', 'font-bold'));
          const currBtn = document.getElementById(`nav-${pIdx}-${cIdx}`);
          if(currBtn) currBtn.classList.add('bg-indigo-50', 'text-primary', 'font-bold');

          // ä¿æŒå½“å‰æ¨¡å¼
          this.switchMode(this.state.mode);
       }

       switchMode(mode) {
          this.state.mode = mode;
          if (mode === 'read') {
             this.el.content.classList.remove('hidden');
             this.el.quizPanel.classList.add('hidden');
             this.el.btnRead.classList.add('bg-white', 'text-primary', 'shadow-sm');
             this.el.btnRead.classList.remove('text-slate-500', 'hover:bg-white/50');
             this.el.btnQuiz.classList.remove('bg-white', 'text-primary', 'shadow-sm');
             this.el.btnQuiz.classList.add('text-slate-500', 'hover:bg-white/50');
          } else {
             this.el.content.classList.add('hidden');
             this.el.quizPanel.classList.remove('hidden');
             this.el.btnQuiz.classList.add('bg-white', 'text-primary', 'shadow-sm');
             this.el.btnQuiz.classList.remove('text-slate-500', 'hover:bg-white/50');
             this.el.btnRead.classList.remove('bg-white', 'text-primary', 'shadow-sm');
             this.el.btnRead.classList.add('text-slate-500', 'hover:bg-white/50');
          }
       }

       renderQuiz(chapId) {
          // å°è¯•ä» window å¯¹è±¡ä¸­è·å–ç»ƒä¹ é¢˜æ•°æ®
          const quizzes = window.GRAMMAR_QUIZZES || {};
          const questions = quizzes[chapId];
          
          this.el.quizContainer.innerHTML = '';
          
          if (!questions || questions.length === 0) {
             this.el.quizContainer.innerHTML = `
               <div class="flex flex-col items-center justify-center h-64 text-slate-400">
                 <i class="fa fa-pencil-square-o text-4xl mb-4"></i>
                 <p>æœ¬ç« èŠ‚æš‚æ— ç»ƒä¹ é¢˜</p>
                 <p class="text-xs mt-2 text-slate-300">è¯·åœ¨ french_data.js ä¸­æ·»åŠ  GRAMMAR_QUIZZES æ•°æ®</p>
               </div>`;
             return;
          }

          questions.forEach((q, idx) => {
             const qEl = document.createElement('div');
             qEl.className = "bg-white p-5 rounded-xl border border-slate-200 shadow-sm";
             qEl.innerHTML = `<div class="font-bold text-slate-800 mb-3"><span class="text-primary mr-2">${idx+1}.</span>${q.q}</div>`;
             
             const optsEl = document.createElement('div');
             q.options.forEach((opt, oIdx) => {
                const btn = document.createElement('button');
                btn.className = "quiz-option";
                btn.textContent = opt;
                btn.onclick = () => this.checkAnswer(btn, oIdx, q.a, q.expl, optsEl);
                optsEl.appendChild(btn);
             });
             qEl.appendChild(optsEl);
             
             const feedbackEl = document.createElement('div');
             feedbackEl.className = "mt-3 hidden text-sm p-3 rounded bg-slate-50 text-slate-600";
             qEl.appendChild(feedbackEl);
             
             this.el.quizContainer.appendChild(qEl);
          });
       }

       checkAnswer(btn, selected, correct, explanation, container) {
          // ç¦ç”¨æ‰€æœ‰é€‰é¡¹
          Array.from(container.children).forEach(b => {
             b.disabled = true;
             if (b === btn) {
                if (selected === correct) {
                   b.classList.add('correct');
                   b.innerHTML += ' <i class="fa fa-check"></i>';
                } else {
                   b.classList.add('wrong');
                   b.innerHTML += ' <i class="fa fa-times"></i>';
                }
             }
             // å¦‚æœé€‰é”™äº†ï¼Œä¹Ÿæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
             // å‡è®¾æˆ‘ä»¬æ— æ³•ç›´æ¥çŸ¥é“å“ªä¸ªé€‰é¡¹ç´¢å¼•æ˜¯æ­£ç¡®çš„ï¼Œé™¤äº†é€šè¿‡ q.a ä¼ é€’è¿›æ¥
             // è¿™é‡Œæˆ‘ä»¬éœ€è¦éå†æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆçš„æŒ‰é’®æ¥æ ‡è®°å®ƒ
             // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬å‡è®¾ container çš„å­å…ƒç´ é¡ºåºå¯¹åº”é€‰é¡¹é¡ºåº
             if (Array.from(container.children).indexOf(b) === correct) {
                 b.classList.add('correct'); 
                 if (!b.innerHTML.includes('fa-check')) {
                    b.innerHTML += ' <i class="fa fa-check"></i>';
                 }
             }
          });

          // æ˜¾ç¤ºè§£æ
          const fb = container.nextElementSibling;
          fb.classList.remove('hidden');
          fb.innerHTML = `<strong>è§£æï¼š</strong> ${explanation || 'æš‚æ— è§£æ'}`;
          if(selected === correct) {
             fb.classList.add('border', 'border-emerald-100', 'bg-emerald-50', 'text-emerald-700');
             fb.classList.remove('border-red-100', 'bg-red-50', 'text-red-700');
          } else {
             fb.classList.add('border', 'border-red-100', 'bg-red-50', 'text-red-700');
             fb.classList.remove('border-emerald-100', 'bg-emerald-50', 'text-emerald-700');
          }
       }
    }

    // å…¨å±€å˜é‡ gm ç”¨äº html onclick è°ƒç”¨
    let gm;

    // ... LessonTrans å’Œ HomeworkTrans ä¿æŒä¸å˜ (çœç•¥ä»¥èŠ‚çœç¯‡å¹…) ...
   class LessonTrans { 
       constructor() { 
          this.lessons = Data.lessonsRaw.map(x=>({
             title:x.title, frFull:x.fr, cnFull:x.cn, 
             frArr:x.fr.split('\n').filter(s=>s.trim()), 
             cnArr:x.cn.split('\n').filter(s=>s.trim()), 
             noPara:x.noPara
          }));
          this.el={
             mode:document.getElementById('ltMode'),
             sel:document.getElementById('ltLesson'),
             src:document.getElementById('ltSource'),
             in:document.getElementById('ltInput'),
             next:document.getElementById('btnLtNext'),
             show:document.getElementById('ltShowRef'),
             refW:document.getElementById('ltRefWrap'),
             ref:document.getElementById('ltRef'),
             prog:document.getElementById('ltProgress')
          }; 
          this.state={idx:0,para:0,revealed:false}; 
          
          this.el.sel.innerHTML='<option value="random">ğŸ² éšæœº</option>'+this.lessons.map((l,i)=>`<option value="${i}">${l.title}</option>`).join(''); 
          this.el.sel.addEventListener('change',()=>this.load()); 
          this.el.mode.addEventListener('change',()=>this.load()); 
          this.el.next.addEventListener('click',()=>this.next()); 
          this.el.show.addEventListener('click',()=>{if(this.state.revealed)this.next();else this.show()}); 
          
          // === ä¿®æ”¹ç‚¹ 1ï¼šå°†å¿«æ·é”®æ”¹ä¸º Ctrl + Enter ===
          this.el.in.addEventListener('keydown',(e)=>{
             if(e.key==='Enter' && e.ctrlKey){ // åªæœ‰æŒ‰ä½ Ctrl æ‰æäº¤
                e.preventDefault();
                if(!this.state.revealed)this.show();
                else this.next();
             }
          }); 
          this.load(); 
       } 
       
       load(){ 
          const i=this.el.sel.value==='random'?Math.floor(Math.random()*this.lessons.length):parseInt(this.el.sel.value); 
          this.curr=this.lessons[i]; 
          this.state={idx:i,para:0,revealed:false};
          if(this.curr.noPara){this.el.mode.value='full';this.el.mode.disabled=true}else{this.el.mode.disabled=false} 
          this.render(); 
       } 
       
       render(){ 
          this.el.in.value=''; 
          // === ä¿®æ”¹ç‚¹ 2ï¼šæ›´æ–°æç¤ºæ–‡å­— ===
          this.el.in.placeholder = "åœ¨æ­¤å°è¯•ç¿»è¯‘... (æŒ‰ Ctrl + Enter æŸ¥çœ‹ç­”æ¡ˆï¼Œæ”¯æŒç›´æ¥å›è½¦æ¢è¡Œ)";
          
          this.el.refW.classList.add('hidden'); 
          this.el.show.textContent="å‚è€ƒ (Ctrl+Enter)"; 
          this.state.revealed=false; 
          
          if(this.el.mode.value==='full'){
             this.el.src.textContent=this.curr.frFull;
             this.el.ref.textContent=this.curr.cnFull;
             this.el.prog.textContent="å…¨æ–‡æ¨¡å¼";
          }else{
             this.el.src.textContent=this.curr.frArr[this.state.para]||"End";
             this.el.ref.textContent=this.curr.cnArr[this.state.para]||"End";
             this.el.prog.textContent=`æ®µè½: ${this.state.para+1}/${this.curr.frArr.length}`;
          } 
       } 
       
       show(){
          this.el.refW.classList.remove('hidden');
          this.el.show.textContent="ä¸‹ä¸€é¢˜ (Ctrl+Enter)";
          this.state.revealed=true;
       } 
       
       next(){
          if(this.el.mode.value==='full'){
             this.load();
          }else{
             if(this.state.para<this.curr.frArr.length-1){
                this.state.para++;
                this.render();
             }else{
                this.load();
             }
          }
       } 
    }
    class HomeworkTrans { constructor() { this.lessons=Data.homeworkRaw; this.el={sel:document.getElementById('hwLesson'),src:document.getElementById('hwSource'),in:document.getElementById('hwInput'),next:document.getElementById('btnHwNext'),show:document.getElementById('btnHwShowRef'),refW:document.getElementById('hwRefWrap'),ref:document.getElementById('hwRef'),prog:document.getElementById('hwProgress')}; this.state={idx:0,qIdx:0,revealed:false}; this.el.sel.innerHTML='<option value="random">ğŸ² éšæœº</option>'+this.lessons.map((l,i)=>`<option value="${i}">${l.title}</option>`).join(''); this.el.sel.addEventListener('change',()=>this.load()); this.el.next.addEventListener('click',()=>this.next()); this.el.show.addEventListener('click',()=>{if(this.state.revealed)this.next();else this.show()}); this.el.in.addEventListener('keydown',(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();if(!this.state.revealed)this.show();else this.next()}}); this.load(); } load(){ const i=this.el.sel.value==='random'?Math.floor(Math.random()*this.lessons.length):parseInt(this.el.sel.value); this.curr=this.lessons[i]; this.state={idx:i,qIdx:0,revealed:false}; this.render(); } render(){ const q=this.curr.qas[this.state.qIdx]; this.el.src.textContent=q.cn; this.el.ref.textContent=q.fr; this.el.prog.textContent=`${this.state.qIdx+1}/${this.curr.qas.length}`; this.el.in.value=''; this.el.refW.classList.add('hidden'); this.el.show.textContent="æŸ¥çœ‹ç­”æ¡ˆ (Enter)"; this.state.revealed=false; } show(){this.el.refW.classList.remove('hidden');this.el.show.textContent="ä¸‹ä¸€é¢˜ (Enter)";this.state.revealed=true} next(){if(this.state.qIdx<this.curr.qas.length-1){this.state.qIdx++;this.render()}else{this.load()}} }
const SUPA_URL = 'https://kyesnqdokdcgkcjxfcvf.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5ZXNucWRva2RjZ2tjanhmY3ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NDg3NzAsImV4cCI6MjA4MjEyNDc3MH0.pzp0K6zwQUiQR99-pRvjsvuHHpcGVyURTby_e9sFEPI';

    class AuthManager {
        constructor(verbMgr) {
            this.verbMgr = verbMgr;
            this.supa = supabase.createClient(SUPA_URL, SUPA_KEY);
            this.user = null;
            this.el = {
                modal: document.getElementById('authModal'),
                email: document.getElementById('authEmail'),
                pwd: document.getElementById('authPwd'),
                msg: document.getElementById('authMsg'),
                display: document.getElementById('authDisplay')
            };
            this.init();
        }

        init() {
            document.getElementById('btnLoginModal').addEventListener('click', () => this.el.modal.classList.remove('hidden'));
            document.getElementById('btnDoLogin').addEventListener('click', () => this.handle('login'));
            document.getElementById('btnDoSignUp').addEventListener('click', () => this.handle('signup'));
            
            // æ£€æŸ¥å½“å‰ä¼šè¯
            this.supa.auth.getSession().then(({ data: { session } }) => {
                if (session?.user) this.onLogin(session.user);
            });
        }

        async handle(type) {
            const email = this.el.email.value;
            const password = this.el.pwd.value;
            this.el.msg.textContent = "å¤„ç†ä¸­...";
            
            const { data, error } = type === 'signup' 
                ? await this.supa.auth.signUp({ email, password })
                : await this.supa.auth.signInWithPassword({ email, password });

            if (error) {
                this.el.msg.textContent = error.message;
            } else {
                if(type === 'signup') alert('æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±ç¡®è®¤é“¾æ¥ï¼ˆå¦‚æœå¼€å¯äº†éªŒè¯ï¼‰ï¼Œæˆ–ç›´æ¥ç™»å½•ã€‚');
                if(type === 'login') this.onLogin(data.user);
            }
        }

        onLogin(user) {
            this.user = user;
            this.el.modal.classList.add('hidden');
            this.el.display.innerHTML = `<span class="text-slate-600"><i class="fa fa-user"></i> ${user.email.split('@')[0]}</span> <button id="btnLogout" class="underline ml-2">é€€å‡º</button>`;
            document.getElementById('btnLogout').onclick = async () => {
                await this.supa.auth.signOut();
                window.location.reload();
            };
            this.loadData();
        }

        async saveData(type, json) {
            if(!this.user) return;
            await this.supa.from('user_progress').upsert({ user_id: this.user.id, data_type: type, content: json }, { onConflict: 'user_id, data_type' });
        }

        async loadData() {
            const { data } = await this.supa.from('user_progress').select('*').eq('user_id', this.user.id);
            if(data) {
                data.forEach(row => {
                    if(row.data_type === 'errors') {
                        this.verbMgr.session.errors = row.content;
                        localStorage.setItem('fr_errors', JSON.stringify(row.content));
                        this.verbMgr.renderErrors();
                    }
                    if(row.data_type === 'progress') {
                        this.verbMgr.progress = row.content;
                        localStorage.setItem('fr_progress', JSON.stringify(row.content));
                        this.verbMgr.updateProgressUI();
                    }
                });
                showToast('äº‘ç«¯æ•°æ®å·²åŒæ­¥', 'success');
            }
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
       if (typeof window.VERB_LIST === 'undefined') { document.getElementById('data-error-banner').classList.remove('hidden'); return; }
       const tabs = document.querySelectorAll('.tab-link'); const sections = document.querySelectorAll('.main-section');
       tabs.forEach(tab => {
          tab.addEventListener('click', () => {
             tabs.forEach(t => { t.classList.remove('bg-white','text-primary','shadow-sm'); t.classList.add('text-slate-600'); });
             tab.classList.add('bg-white','text-primary','shadow-sm'); tab.classList.remove('text-slate-600');
             sections.forEach(s => s.classList.add('hidden'));
             document.getElementById(tab.dataset.section).classList.remove('hidden');
          });
       });
       new VerbManager();
       gm = new GrammarManager(); // åˆå§‹åŒ–å¹¶èµ‹å€¼ç»™å…¨å±€å˜é‡
       new LessonTrans();
       new HomeworkTrans();
    });
  </script>
</body>
</html>

